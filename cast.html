<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Star Wars Characters - GeorgiaJedi</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/bootstrap-table.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    #toolbar { margin: 10px 0; }
    #loading { font-size: 1.25rem; font-weight: 500; }
    .column-filter { width: 100%; font-size: 0.9em; padding: 2px; margin-top: 4px; }
    .dropdown-menu label {
      display: block;
      margin: 0;
      cursor: pointer;
    }
    .selected-tags span.badge {
      margin-right: 5px;
    }
    th.sortable { position: relative; }
    th.sortable .column-filter { pointer-events: auto; position: relative; z-index: 1; }
    th.sortable .th-inner { pointer-events: none; }
  </style>
</head>
<body>
<header class="d-flex align-items-center justify-content-center py-4">
  <img src="images/GeorgiaJedi-logo-256.jpg" alt="GeorgiaJedi Logo" class="logo mr-3">
  <h1 class="mx-auto">Star Wars Character Catalog</h1>
</header>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="#">GeorgiaJedi</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link" href="autographs.html">Autographs</a></li>
      <li class="nav-item"><a class="nav-link" href="collectibles.html">Collectibles</a></li>
      <li class="nav-item active"><a class="nav-link" href="cast.html">Cast/Crew</a></li>
      <li class="nav-item"><a class="nav-link" href="add-item.html">Add Item</a></li>
    </ul>
  </div>
</nav>

<main class="container my-5">
  <div id="loading" class="text-center my-5">Loading characters...</div>

  <div id="toolbar" class="d-flex align-items-center flex-wrap" style="display: none;">
    <div class="btn-group mr-3 mb-2">
      <button id="professionDropdownBtn" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Filter Professions
      </button>
      <div class="dropdown-menu p-2" id="professionDropdown" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
    <div class="form-check mr-3 mb-2">
      <input type="checkbox" class="form-check-input" id="excludeCheckbox">
      <label class="form-check-label" for="excludeCheckbox">Exclude selected</label>
    </div>
    <button id="clearAll" class="btn btn-sm btn-outline-danger ml-auto mb-2">Clear All</button>

    <div class="btn-group ml-3 mb-2">
      <button id="exportModeBtn" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Export Mode: Visible
      </button>
      <div class="dropdown-menu">
        <a class="dropdown-item export-mode active" href="#" data-mode="page">Visible Data</a>
        <a class="dropdown-item export-mode" href="#" data-mode="filtered">Filtered Data</a>
      </div>
    </div>

<!--     <div class="btn-group ml-3 mb-2">
      <button class="btn btn-outline-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Export</button>
    </div>
 -->
  </div>

  <div class="my-2 selected-tags" id="selectedTags"></div>

  <table id="characterTable"
         class="table table-bordered"
         style="display: none;"
         data-toggle="table"
         data-pagination="true"
         data-pagination-v-align="both"
         data-click-to-select="true"
         data-toolbar="#toolbar"
         data-page-size="10"
         data-show-export="true"
        >
    <thead>
      <tr>
        <th data-field="state" checkbox></th>
        <th data-field="id" data-sortable="true">ID</th>
        <th data-field="name" data-sortable="true" class="sortable">
          Name
          <div><input type="text" class="column-filter" data-column="name" placeholder="Search name"></div>
        </th>
        <th data-field="professions" data-sortable="true">Professions</th>
        <th data-field="known_for" data-sortable="true" class="sortable">
          Known For
          <div><input type="text" class="column-filter" data-column="known_for" placeholder="Search known for"></div>
        </th>
        <th data-field="bio" data-sortable="true" class="sortable">
          Biography
          <div><input type="text" class="column-filter" data-column="bio" placeholder="Search bio"></div>
        </th>
      </tr>
    </thead>
  </table>
</main>

<footer class="text-center py-4">
  <p>&copy; 2024 GeorgiaJedi. All rights reserved.</p>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/bootstrap-table.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/extensions/export/bootstrap-table-export.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.29.0/tableExport.min.js"></script>

<script>
  const $table = $('#characterTable');
  const $loading = $('#loading');
  const $toolbar = $('#toolbar');
  const $dropdown = $('#professionDropdown');
  const $excludeCheckbox = $('#excludeCheckbox');
  const $selectedTags = $('#selectedTags');
  let allData = [];
  let exportMode = 'page';
  let originalPageSize = 10;
  let isFilteredPageSizeActive = false;

  const worker = new Worker('js/castworker.js');
  worker.postMessage('load');

  function renderTags(selected) {
    $selectedTags.empty();
    selected.forEach(val => {
      const badge = $(`<span class="badge badge-secondary">${val} <span class="ml-1" style="cursor:pointer;">&times;</span></span>`);
      badge.find('span').on('click', () => {
        $dropdown.find(`input[value="${val}"]`).prop('checked', false);
        applyFilters();
      });
      $selectedTags.append(badge);
    });
  }

  function applyFilters() {
    const selected = $dropdown.find('input:checked').map(function () {
      return $(this).val();
    }).get();

    const exclude = $excludeCheckbox.is(':checked');
    renderTags(selected);

    const inputFilters = {};
    $('.column-filter').each(function () {
      const col = $(this).data('column');
      const val = $(this).val().toLowerCase();
      if (val) inputFilters[col] = val;
    });

    const filtered = allData.filter(row => {
      const profs = row.professions.split(',').map(p => p.trim());
      const matchesProfession = selected.length === 0 || (
        exclude
          ? !selected.some(sel => profs.includes(sel))
          : selected.some(sel => profs.includes(sel))
      );

      const matchesInputs = Object.entries(inputFilters).every(([key, val]) =>
        (row[key] || '').toLowerCase().includes(val)
      );

      return matchesProfession && matchesInputs;
    });

    $table.bootstrapTable('load', filtered);

    if (exportMode === 'filtered') {
      originalPageSize = $table.bootstrapTable('getOptions').pageSize;
      isFilteredPageSizeActive = true;
      $table.bootstrapTable('refreshOptions', { pageSize: filtered.length });
    }
  }

  function initTable() {
    $table.bootstrapTable('destroy').bootstrapTable({
      data: allData,
      pagination: true,
      pageSize: originalPageSize,
      clickToSelect: true,
      showExport: true,
      exportDataType: exportMode,
      exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf'],
      exportOptions: {
        fileName: 'StarWarsCharacters',
        ignoreColumn: ['state']
      },
      toolbar: '#toolbar'
    });
  }

  $('#toolbar').on('click', '.export-mode', function (e) {
    e.preventDefault();
    exportMode = $(this).data('mode');
    $('#exportModeBtn').text('Export Mode: ' + (exportMode === 'filtered' ? 'Filtered Data' : 'Visible'));
    $('.export-mode').removeClass('active');
    $(this).addClass('active');

    if (exportMode !== 'filtered' && isFilteredPageSizeActive) {
      $table.bootstrapTable('refreshOptions', { pageSize: originalPageSize });
      isFilteredPageSizeActive = false;
    }

    initTable();
    applyFilters();
  });

  

  $(document).on('click', '.dropdown-menu a[data-type]', function (e) {
    const type = $(this).data('type');

    if (exportMode === 'filtered') {
      setTimeout(() => {
        $table.bootstrapTable('export', {
          type: type,
          escape: false
        });

        if (isFilteredPageSizeActive) {
          setTimeout(() => {
            $table.bootstrapTable('refreshOptions', { pageSize: originalPageSize });
            isFilteredPageSizeActive = false;
          }, 100);
        }
      }, 100);

      e.preventDefault();
    }
  });

  worker.onmessage = function (e) {
    if (Array.isArray(e.data)) {
      allData = e.data;

      const profCounts = {};
      allData.forEach(row => {
        row.professions.split(',').map(p => p.trim()).forEach(p => {
          profCounts[p] = (profCounts[p] || 0) + 1;
        });
      });

      Object.entries(profCounts).sort().forEach(([prof, count]) => {
        const label = $(`<label><input type="checkbox" value="${prof}"> ${prof} (${count})</label>`);
        $dropdown.append(label);
      });

      $loading.hide();
      $toolbar.show();
      $table.show();

      initTable();

      $dropdown.on('change', 'input[type="checkbox"]', applyFilters);
      $excludeCheckbox.on('change', applyFilters);
      $('#clearAll').on('click', function () {
        $dropdown.find('input').prop('checked', false);
        $excludeCheckbox.prop('checked', false);
        $('.column-filter').val('');
        applyFilters();
      });
      $('.column-filter').on('input', applyFilters);

      $table.on('click', 'th', function (event) {
        const $target = $(event.target);
        if (
          $target.closest('.column-filter').length > 0 ||
          $target.is('input, select, textarea, button, label') ||
          $target.parents('.dropdown-menu').length > 0
        ) {
          event.stopPropagation();
        }
      });

      applyFilters();
    } else {
      $loading.text('Failed to load characters.');
    }
  };
</script>
</body>
</html>
