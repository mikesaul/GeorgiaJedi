<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Star Wars Characters</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/bootstrap-table.min.css"/>
  <style>
    #toolbar {
      margin-bottom: 1rem;
    }
    .bootstrap-table .filter-control input,
    .bootstrap-table .filter-control select {
      height: 30px;
      font-size: 0.9rem;
      padding: 2px;
    }
    #loading {
      font-size: 1.25rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2 class="text-center">Star Wars Characters</h2>

    <div id="loading" class="text-center mt-5">Loading characters...</div>

    <div id="toolbar" class="select" style="display: none;">
      <select class="form-control d-inline w-auto">
        <option value="basic">Export Basic</option>
        <option value="all">Export All</option>
        <option value="selected">Export Selected</option>
      </select>
      <button id="exportButton" class="btn btn-primary ml-2">Export Selected</button>
    </div>

    <table id="characterTable"
           style="display: none;"
           data-toggle="table"
           data-pagination="true"
           data-click-to-select="true"
           data-toolbar="#toolbar"
           data-filter-control="true"
           data-filter-show-clear="true"
           data-page-size="10"
           data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf']">
      <thead>
        <tr>
          <th data-field="state" checkbox></th>
          <th data-field="id" data-sortable="true">ID</th>
          <th data-field="name" data-sortable="true" data-filter-control="select">Name</th>
          <th data-field="professions"
              data-sortable="true"
              data-filter-control="select"
              data-filter-control-placeholder="Filter by Profession">
            Professions
          </th>
          <th data-field="known_for" data-sortable="true" data-filter-control="input">Known For</th>
          <th data-field="bio" data-sortable="true" data-filter-control="input">Biography</th>
        </tr>
      </thead>
    </table>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/bootstrap-table.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.29.0/tableExport.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.29.0/libs/jsPDF/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/extensions/export/bootstrap-table-export.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>

  <script>
    $(function () {
      const $table = $('#characterTable');
      let allData = [];
      let selectedProfession = '';

      $.getJSON('data/cast.json', function (data) {
        // Normalize professions
        data.forEach(row => {
          if (Array.isArray(row.professions)) {
            row.professions = row.professions.join(', ');
          }
        });

        allData = data;

        // Show table and toolbar
        $('#loading').hide();
        $table.show();
        $('#toolbar').show();

        // Initialize table
        $table.bootstrapTable({
          data: allData,
          pagination: true,
          pageSize: 25,
          showExport: true,
          clickToSelect: true,
          toolbar: '#toolbar',
          exportDataType: 'basic',
          exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf'],
          filterControl: true,
          filterShowClear: true
        });

        // Wait for table to fully render then inject dropdown
        setTimeout(() => {
  const $headerFilterCell = $('thead th[data-field="professions"] .filter-control');
  $headerFilterCell.empty();

  const uniqueProfessions = [...new Set(
    allData.flatMap(row =>
      row.professions?.split(',').map(p => p.trim()) || []
    )
  )].sort();

  const $select = $('<select class="form-control"></select>');
  $select.append('<option value="">Show All</option>');
  uniqueProfessions.forEach(prof => {
    $select.append(`<option value="${prof}">${prof}</option>`);
  });

  $select.val(selectedProfession); // Preserve current selection
  $headerFilterCell.append($select);

  $select.on('change', function () {
    selectedProfession = $(this).val();

    const filtered = selectedProfession
      ? allData.filter(row =>
          row.professions &&
          row.professions.split(',').map(p => p.trim()).includes(selectedProfession)
        )
      : allData;

    $table.bootstrapTable('load', filtered);

    // Re-apply dropdown selection after reload
    setTimeout(() => {
      $select.val(selectedProfession);
    }, 100);
  });
}, 200);

      });
    });
  </script>
</body>
</html>
